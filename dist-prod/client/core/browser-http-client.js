"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BrowserHttpClient=void 0;const tslib_1=require("tslib"),base_http_client_1=require("../../common/core/base-http-client"),http_utils_1=require("../../common/utils/http-utils"),axios_1=tslib_1.__importStar(require("axios"));class BrowserHttpClient extends base_http_client_1.BaseHttpClient{constructor(){super(...arguments),this.tokenStorage="localStorage"}async request(t,e,r,s){let i=0;const o=async()=>{var n,a,h,c,u;try{const i=this.buildRequestUrl(e),o=this.prepareHeaders((null==s?void 0:s.headers)||{},void 0!==(null==s?void 0:s.withAuth)&&s.withAuth),n=(null==s?void 0:s.params)?http_utils_1.HttpUtils.addQueryParams(i,s.params):i,a=await axios_1.default.request({method:t,url:n,data:r,headers:o,timeout:(null==s?void 0:s.timeout)||this.defaultTimeout});return this.metricsConfig.enabled&&(this.trackActivity("request"),this.metricsConfig.trackPerformance),{data:a.data,status:a.status,headers:a.headers,config:a.config}}catch(l){if((0,axios_1.isAxiosError)(l)){if(401===(null===(n=l.response)||void 0===n?void 0:n.status)&&this.getAccessToken()&&this.authConfig.autoRefresh)try{return this.request(t,e,r,s)}catch(t){}const d={data:null,status:(null===(a=l.response)||void 0===a?void 0:a.status)||500,headers:(null===(h=l.response)||void 0===h?void 0:h.headers)||{},error:(null===(u=null===(c=l.response)||void 0===c?void 0:c.data)||void 0===u?void 0:u.message)||l.message,code:l.code};if(this.shouldRetry(d,i,null==s?void 0:s.retryOptions)){i++;const t=this.calculateRetryDelay(i,null==s?void 0:s.retryOptions);return this.metricsConfig.enabled&&this.trackActivity("retry"),await new Promise((e=>setTimeout(e,t))),o()}return d}const d={data:null,status:500,headers:{},error:this.parseErrorMessage(l),code:l.code};if(this.shouldRetry(d,i,null==s?void 0:s.retryOptions)){i++;const t=this.calculateRetryDelay(i,null==s?void 0:s.retryOptions);return this.metricsConfig.enabled&&this.trackActivity("retry"),await new Promise((e=>setTimeout(e,t))),o()}return d}};return o()}async login(t){if(!this.authConfig.loginEndpoint)throw new Error("No se ha configurado el endpoint de login");try{const e=await this.post(this.authConfig.loginEndpoint,t);if(e.error||!e.data)throw new Error(e.error||"Error de autenticación");const{token:r,refreshToken:s,user:i}=e.data;return this._storeToken(this.authConfig.tokenKey||"token",r),s&&this.authConfig.refreshTokenKey&&this._storeToken(this.authConfig.refreshTokenKey,s),i&&this.authConfig.userKey&&this._storeToken(this.authConfig.userKey,JSON.stringify(i)),e.data}catch(t){throw t}}async logout(){if(this.authConfig.logoutEndpoint)try{await this.post(this.authConfig.logoutEndpoint,{},{withAuth:!0})}catch(t){}this._removeToken(this.authConfig.tokenKey||"token"),this.authConfig.refreshTokenKey&&this._removeToken(this.authConfig.refreshTokenKey),this.authConfig.userKey&&this._removeToken(this.authConfig.userKey)}isAuthenticated(){const t=this.getAccessToken();if(!t)return!1;try{const e=this._decodeToken(t);if(e&&e.exp)return!this._isTokenExpired(e.exp)}catch(t){return!1}return!0}getAuthenticatedUser(){if(!this.authConfig.userKey)return null;try{const t=this._getToken(this.authConfig.userKey);return t?JSON.parse(t):null}catch(t){return null}}getAccessToken(){return this._getToken(this.authConfig.tokenKey||"token")}invalidateCache(t){if(this.cacheConfig.enabled)try{const e=this._getStorage(),r=Object.keys(e);r.filter((e=>e.startsWith("http_cache_")&&e.includes(t))).forEach((t=>e.removeItem(t)))}catch(t){console.error("Error al invalidar caché:",t)}}invalidateCacheByTags(t){if(this.cacheConfig.enabled&&t.length)try{const e=this._getStorage(),r=Object.keys(e);r.filter((t=>t.startsWith("http_cache_"))).forEach((r=>{try{const s=JSON.parse(e.getItem(r)||"{}");if(s.tags&&Array.isArray(s.tags)){t.some((t=>s.tags.includes(t)))&&e.removeItem(r)}}catch(t){}}))}catch(t){console.error("Error al invalidar caché por tags:",t)}}trackActivity(t){if(this.metricsConfig.enabled)try{const e="http_metrics",r=this.getCurrentMetrics();"request"===t?r.requests=(r.requests||0)+1:"error"===t?r.errors=(r.errors||0)+1:"cache_hit"===t?r.cacheHits=(r.cacheHits||0)+1:"cache_miss"===t&&(r.cacheMisses=(r.cacheMisses||0)+1),localStorage.setItem(e,JSON.stringify(r))}catch(t){}}getCurrentMetrics(){try{const t="http_metrics",e=localStorage.getItem(t);if(e)return JSON.parse(e)}catch(t){}return{requests:0,errors:0,cacheHits:0,cacheMisses:0}}_storeToken(t,e){this._getStorage().setItem(t,e)}_getToken(t){return this._getStorage().getItem(t)}_removeToken(t){this._getStorage().removeItem(t)}_getStorage(){return"sessionStorage"===this.tokenStorage?sessionStorage:localStorage}_decodeToken(t){try{const e=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(window.atob(e).split("").map((t=>"%"+("00"+t.charCodeAt(0).toString(16)).slice(-2))).join(""));return JSON.parse(r)}catch(t){return null}}_isTokenExpired(t){return t<Math.floor(Date.now()/1e3)}}exports.BrowserHttpClient=BrowserHttpClient;