"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HttpClient=void 0;const socks_proxy_agent_1=require("socks-proxy-agent"),http_core_1=require("../../http-core"),http_helpers_1=require("../../http-helpers"),http_auth_1=require("../../http-auth"),http_interceptors_manager_1=require("../../interceptors/http-interceptors-manager"),http_metrics_index_1=require("../../metrics/http-metrics-index"),http_streaming_1=require("../../http-streaming"),https_proxy_agent_1=require("https-proxy-agent"),http_logger_1=require("../../http-logger"),http_property_manager_1=require("../managers/http-property-manager"),http_auth_manager_1=require("../managers/http-auth-manager"),http_config_manager_1=require("../managers/http-config-manager");function createResourceAccessor(e,t){return new Proxy((function(...r){return e.apply(t,r)}),{get:(r,s)=>s in Function.prototype?r[s]:function(...r){let n=r[0];if("string"!=typeof n||0!==n.indexOf("http")&&0!==n.indexOf("/")){let e;e=formatResource("symbol"==typeof s?Symbol.keyFor(s)||s.toString().replace(/Symbol\(|\)/g,""):String(s)),n=e}const a=[n,...r.slice(1)];return e.apply(t,a)},apply:(r,s,n)=>Reflect.apply(e,t,n)})}function formatResource(e){if(/^[A-Z][a-zA-Z0-9]*$/.test(e)){const t=e.charAt(0).toLowerCase()+e.slice(1);return t.endsWith("s")?t:`${t}s`}return e}class HttpClient{constructor(){this.core=new http_core_1.HttpCore,this.get=null,this.getAll=null,this.getById=null,this.post=null,this.put=null,this.patch=null,this.delete=null,this.stream=null,this.logger=http_logger_1.httpLogger,this.propertyManager=new http_property_manager_1.HttpPropertyManager(this.core),this.authManager=new http_auth_manager_1.HttpAuthManager,this.configManager=new http_config_manager_1.HttpConfigManager(this.propertyManager),this.initResourceAccessors()}initResourceAccessors(){this.get=createResourceAccessor(this.getMethod.bind(this),this),this.getAll=createResourceAccessor(this.getAllMethod.bind(this),this),this.getById=createResourceAccessor(this.getByIdMethod.bind(this),this),this.post=createResourceAccessor(this.postMethod.bind(this),this),this.put=createResourceAccessor(this.putMethod.bind(this),this),this.patch=createResourceAccessor(this.patchMethod.bind(this),this),this.delete=createResourceAccessor(this.deleteMethod.bind(this),this),this.stream=createResourceAccessor(this.streamMethod.bind(this),this)}get _baseUrl(){return this.propertyManager.baseUrl}set _baseUrl(e){this.propertyManager.baseUrl=e}get _frontendUrl(){return this.propertyManager.frontendUrl}set _frontendUrl(e){this.propertyManager.frontendUrl=e}get _defaultTimeout(){return this.propertyManager.defaultTimeout}set _defaultTimeout(e){this.propertyManager.defaultTimeout=e}get _defaultRetries(){return this.propertyManager.defaultRetries}set _defaultRetries(e){this.propertyManager.defaultRetries=e}get _defaultHeaders(){return this.propertyManager.defaultHeaders}set _defaultHeaders(e){this.propertyManager.defaultHeaders=e}get _requestInterceptors(){return http_interceptors_manager_1.interceptorsManager.getRequestInterceptors()}get _responseInterceptors(){return http_interceptors_manager_1.interceptorsManager.getResponseInterceptors()}get _proxyConfig(){return this.propertyManager.proxyConfig}set _proxyConfig(e){this.propertyManager.proxyConfig=e}get _defaultStreamConfig(){return this.propertyManager.streamConfig}set _defaultStreamConfig(e){this.propertyManager.streamConfig=e}async request(e,t={}){return this.core.request(e,t)}async getMethod(e,t){return this.core.get(e,t)}async getAllMethod(e,t){return this.core.getAll(e,t)}async getByIdMethod(e,t,r){return this.core.getById(e,t,r)}async postMethod(e,t,r){return this.core.post(e,t,r)}async putMethod(e,t,r){return this.core.put(e,t,r)}async patchMethod(e,t,r){return this.core.patch(e,t,r)}async deleteMethod(e,t){return this.core.delete(e,t)}async streamMethod(e,t={}){return http_streaming_1.streamingManager.stream(e,t)}_setupInterceptors(e,t){http_interceptors_manager_1.interceptorsManager.setupInterceptors(e,t)}configureAuth(e){this.authManager.configureAuth(e)}async login(e){const t=await(0,http_auth_1.login)(e),r={accessToken:t.access_token,isAuthenticated:!0,refreshToken:t.refresh_token};return r.isAuthenticated&&http_metrics_index_1.metricsManager.startTracking(),r}async logout(){const e=await http_metrics_index_1.metricsManager.stopTracking();return e&&console.log(`[HTTP] Sesi√≥n finalizada - Tiempo activo: ${Math.round(e.activeTime/1e3)}s, Peticiones: ${e.requestCount}`),(0,http_auth_1.logout)()}isAuthenticated(){return this.authManager.isAuthenticated()}async getAuthenticatedUser(){return this.authManager.getAuthenticatedUser()}getAccessToken(){return this.authManager.getAccessToken()}async _refreshToken(){return this.authManager.refreshToken()}async _handleRefreshTokenFailure(){return this.authManager.handleRefreshTokenFailure()}_decodeToken(e){return this.authManager.decodeToken(e)}_isTokenExpired(e){return this.authManager.isTokenExpired(e)}_storeToken(e,t){this.authManager.storeToken(e,t)}_getToken(e){return this.authManager.getToken(e)}_removeToken(e){this.authManager.removeToken(e)}async initialize(e){return this.configManager.initialize(e)}configureCaching(e){this.configManager.configureCaching(e)}invalidateCache(e){this.configManager.invalidateCache(e)}invalidateCacheByTags(e){this.configManager.invalidateCacheByTags(e)}configureMetrics(e){this.configManager.configureMetrics(e)}trackActivity(e){this.configManager.trackActivity(e)}getCurrentMetrics(){return this.configManager.getCurrentMetrics()}configureProxy(e){this.configManager.configureProxy(e)}_buildUrl(e){return e.startsWith("http://")||e.startsWith("https://")?e:this.core._baseUrl?this.core._baseUrl.endsWith("/")&&e.startsWith("/")?`${this.core._baseUrl}${e.substring(1)}`:this.core._baseUrl.endsWith("/")||e.startsWith("/")?`${this.core._baseUrl}${e}`:`${this.core._baseUrl}/${e}`:e}_prepareHeaders(e){return(0,http_helpers_1.prepareHeaders)(e.headers||{},e.withAuth||!1)}_createProxyAgent(e){if(!e)return;const{url:t,protocol:r="http",auth:s,rejectUnauthorized:n=!1}=e,a=new URL(t);s&&(a.username=s.username,a.password=s.password);const i=a.toString();return"socks"===r?new socks_proxy_agent_1.SocksProxyAgent(i):(process.env.NODE_TLS_REJECT_UNAUTHORIZED=n?"1":"0",new https_proxy_agent_1.HttpsProxyAgent(i))}}exports.HttpClient=HttpClient;