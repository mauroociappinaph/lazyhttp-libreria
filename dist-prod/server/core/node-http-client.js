"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.NodeHttpClient=void 0;const tslib_1=require("tslib"),base_http_client_1=require("../../common/core/base-http-client"),http_utils_1=require("../../common/utils/http-utils"),axios_1=tslib_1.__importStar(require("axios")),fs=tslib_1.__importStar(require("fs")),path=tslib_1.__importStar(require("path")),http=tslib_1.__importStar(require("http")),https=tslib_1.__importStar(require("https"));class NodeHttpClient extends base_http_client_1.BaseHttpClient{constructor(){super(),this.tokenStorage={},this.cacheDirectory=path.join(process.cwd(),".cache"),this.httpAgent=new http.Agent({keepAlive:!0}),this.httpsAgent=new https.Agent({keepAlive:!0}),this.setupCacheDirectory()}onInitialize(t){t.cacheDirectory&&(this.cacheDirectory=t.cacheDirectory,this.setupCacheDirectory())}async request(t,e,r,s){var i,o,n,a;const h=this.buildRequestUrl(e),c=this.prepareHeaders((null==s?void 0:s.headers)||{},void 0!==(null==s?void 0:s.withAuth)&&s.withAuth),u={method:t,url:(null==s?void 0:s.params)?http_utils_1.HttpUtils.addQueryParams(h,s.params):h,data:r,headers:c,timeout:(null==s?void 0:s.timeout)||this.defaultTimeout,httpAgent:this.httpAgent,httpsAgent:this.httpsAgent};if(this.proxyConfig){const t=this._createProxyAgent(this.proxyConfig);t&&(u.httpAgent=t,u.httpsAgent=t)}try{const t=await axios_1.default.request(u);return this.metricsConfig.enabled&&(this.trackActivity("request"),this.metricsConfig.trackPerformance),{data:t.data,status:t.status,headers:t.headers,config:t.config}}catch(t){return(0,axios_1.isAxiosError)(t)?{data:null,status:(null===(i=t.response)||void 0===i?void 0:i.status)||500,headers:(null===(o=t.response)||void 0===o?void 0:o.headers)||{},error:(null===(a=null===(n=t.response)||void 0===n?void 0:n.data)||void 0===a?void 0:a.message)||t.message}:{data:null,status:500,headers:{},error:this.parseErrorMessage(t)}}}_createProxyAgent(t){try{if("http"===t.protocol||"https"===t.protocol){const e=t.auth?`${t.auth.username}:${t.auth.password}@`:"",r=`${t.protocol}://${e}${t.host}:${t.port}`;return void console.log(`Creating HTTP/HTTPS proxy agent for ${r}`)}if("socks4"===t.protocol||"socks5"===t.protocol){const e=t.auth?`${t.auth.username}:${t.auth.password}@`:"",r=`${t.protocol}://${e}${t.host}:${t.port}`;return void console.log(`Creating SOCKS proxy agent for ${r}`)}}catch(t){console.error("Error creating proxy agent:",t)}}async login(t){if(!this.authConfig.loginEndpoint)throw new Error("No se ha configurado el endpoint de login");try{const e=await this.post(this.authConfig.loginEndpoint,t);if(e.error||!e.data)throw new Error(e.error||"Error de autenticación");const{token:r,refreshToken:s,user:i}=e.data;return this._storeToken(this.authConfig.tokenKey||"token",r),s&&this.authConfig.refreshTokenKey&&this._storeToken(this.authConfig.refreshTokenKey,s),i&&this.authConfig.userKey&&this._storeToken(this.authConfig.userKey,JSON.stringify(i)),e.data}catch(t){throw t}}async logout(){if(this.authConfig.logoutEndpoint)try{await this.post(this.authConfig.logoutEndpoint,{},{withAuth:!0})}catch(t){}this._removeToken(this.authConfig.tokenKey||"token"),this.authConfig.refreshTokenKey&&this._removeToken(this.authConfig.refreshTokenKey),this.authConfig.userKey&&this._removeToken(this.authConfig.userKey)}isAuthenticated(){const t=this.getAccessToken();if(!t)return!1;try{const e=this._decodeToken(t);if(e&&e.exp)return!this._isTokenExpired(e.exp)}catch(t){return!1}return!0}getAuthenticatedUser(){if(!this.authConfig.userKey)return null;try{const t=this._getToken(this.authConfig.userKey);return t?JSON.parse(t):null}catch(t){return null}}getAccessToken(){return this._getToken(this.authConfig.tokenKey||"token")}invalidateCache(t){if(this.cacheConfig.enabled)try{const e=this.getCacheFiles();e.filter((e=>e.includes(t))).forEach((t=>{const e=path.join(this.cacheDirectory,t);fs.unlinkSync(e)}))}catch(t){console.error("Error al invalidar caché:",t)}}invalidateCacheByTags(t){if(this.cacheConfig.enabled&&t.length)try{this.getCacheFiles().forEach((e=>{try{const r=path.join(this.cacheDirectory,e),s=fs.readFileSync(r,"utf8"),i=JSON.parse(s);if(i.tags&&Array.isArray(i.tags)){t.some((t=>i.tags.includes(t)))&&fs.unlinkSync(r)}}catch(t){}}))}catch(t){console.error("Error al invalidar caché por tags:",t)}}trackActivity(t){if(this.metricsConfig.enabled)try{const e=path.join(this.cacheDirectory,"http_metrics.json"),r=this.getCurrentMetrics();"request"===t?r.requests=(r.requests||0)+1:"error"===t?r.errors=(r.errors||0)+1:"cache_hit"===t?r.cacheHits=(r.cacheHits||0)+1:"cache_miss"===t&&(r.cacheMisses=(r.cacheMisses||0)+1),fs.writeFileSync(e,JSON.stringify(r),"utf8")}catch(t){}}getCurrentMetrics(){try{const t=path.join(this.cacheDirectory,"http_metrics.json");if(fs.existsSync(t)){const e=fs.readFileSync(t,"utf8");return JSON.parse(e)}}catch(t){}return{requests:0,errors:0,cacheHits:0,cacheMisses:0}}setupCacheDirectory(){fs.existsSync(this.cacheDirectory)||fs.mkdirSync(this.cacheDirectory,{recursive:!0})}getCacheFiles(){try{return fs.readdirSync(this.cacheDirectory).filter((t=>t.startsWith("http_cache_")))}catch(t){return[]}}_storeToken(t,e){this.tokenStorage[t]=e}_getToken(t){return this.tokenStorage[t]||null}_removeToken(t){delete this.tokenStorage[t]}_decodeToken(t){try{const e=t.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=Buffer.from(e,"base64").toString("utf-8");return JSON.parse(r)}catch(t){return null}}_isTokenExpired(t){return t<Math.floor(Date.now()/1e3)}}exports.NodeHttpClient=NodeHttpClient;