"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.cacheManager=void 0,exports.configure=configure,exports.isEnabled=isEnabled,exports.generateCacheKey=generateCacheKey,exports.get=get,exports.set=set,exports.remove=remove,exports.clear=clear,exports.invalidate=invalidate,exports.invalidateByTags=invalidateByTags,exports.invalidateByMethod=invalidateByMethod,exports.shouldUseCache=shouldUseCache,exports.getStrategy=getStrategy;const cacheState={config:{enabled:!1,defaultStrategy:"cache-first",defaultTTL:3e5,storage:"memory",maxSize:100},cache:new Map};function configure(e){cacheState.config={...cacheState.config,...e},cacheState.config.enabled||clear()}function isEnabled(){return cacheState.config.enabled}function generateCacheKey(e,t){var a,c;if(null===(a=null==t?void 0:t.cache)||void 0===a?void 0:a.key)return t.cache.key;let n=e.startsWith("/")?e:`/${e}`;if(null==t?void 0:t.params){const e=new URLSearchParams;Object.entries(t.params).forEach((([t,a])=>{e.append(t,String(a))})),n+=`?${e.toString()}`}const i=(null==t?void 0:t.method)||"GET";let o="";return(null===(c=null==t?void 0:t.cache)||void 0===c?void 0:c.tags)&&t.cache.tags.length>0&&(o=`:tags=${t.cache.tags.sort().join(",")}`),`${i}:${n}${o}`}function get(e){const t=cacheState.cache.get(e);if(t){if(!(Date.now()>t.expiresAt))return t.lastAccessed=Date.now(),cacheState.cache.set(e,t),t.value;remove(e)}}function set(e,t,a){var c,n;if(!cacheState.config.enabled)return;cacheState.cache.size>=cacheState.config.maxSize&&evictOldEntries();const i=null!==(c=null==a?void 0:a.ttl)&&void 0!==c?c:cacheState.config.defaultTTL,o=null!==(n=null==a?void 0:a.tags)&&void 0!==n?n:[],r={value:t,expiresAt:Date.now()+i,createdAt:Date.now(),lastAccessed:Date.now(),tags:o};cacheState.cache.set(e,r)}function remove(e){cacheState.cache.delete(e)}function clear(){cacheState.cache.clear()}function invalidate(e){const t=new RegExp(e.replace(/\*/g,".*"));for(const e of cacheState.cache.keys())t.test(e)&&remove(e)}function invalidateByTags(e){for(const[t,a]of cacheState.cache.entries())a.tags&&a.tags.some((t=>e.includes(t)))&&remove(t)}function invalidateByMethod(e,t){if("GET"===e)return;invalidate(`GET:${t.split("/").slice(0,-1).join("/")||t}*`)}function shouldUseCache(e,t){var a;return!!cacheState.config.enabled&&(!1!==(null===(a=null==t?void 0:t.cache)||void 0===a?void 0:a.enabled)&&"GET"===e)}function getStrategy(e){var t;return(null===(t=null==e?void 0:e.cache)||void 0===t?void 0:t.strategy)||cacheState.config.defaultStrategy}function evictOldEntries(){const e=Array.from(cacheState.cache.entries()).sort((([,e],[,t])=>e.lastAccessed-t.lastAccessed)),t=Math.ceil(.1*cacheState.config.maxSize);e.slice(0,t).forEach((([e])=>remove(e)))}exports.cacheManager={configure:configure,isEnabled:isEnabled,generateCacheKey:generateCacheKey,get:get,set:set,delete:remove,clear:clear,invalidate:invalidate,invalidateByTags:invalidateByTags,invalidateByMethod:invalidateByMethod,shouldUseCache:shouldUseCache,getStrategy:getStrategy};