#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Ejecutando verificaciones pre-commit con Husky para httplazy..."

# 1. Lint y formato sobre archivos staged
npx lint-staged
if [ $? -ne 0 ]; then
  echo "â›” Fallaron las verificaciones de linting o formato. No se puede realizar el commit."
  exit 1
fi

# 2. Test unitarios relacionados con los cambios
echo "ğŸ§ª Ejecutando tests unitarios relacionados..."
# Ejecuta tests solo para los archivos relacionados con los cambios staged
pnpm test --findRelatedTests $(git diff --name-only --cached)
if [ $? -ne 0 ]; then
  echo "â›” Los tests fallaron. No se puede realizar el commit."
  exit 1
fi

# 3. VerificaciÃ³n de dependencias circulares
echo "ğŸ“Š Verificando dependencias circulares..."
npx madge --circular http/
if [ $? -ne 0 ]; then
  echo "â›” Se detectaron dependencias circulares. Ejecuta 'npx madge --circular http/' para mÃ¡s detalles."
  exit 1
fi

# 4. RevisiÃ³n de export default
echo "ğŸ“¦ Verificando reglas de exportaciÃ³n..."
grep -r "export default" http/ --include="*.ts" | grep -v "node_modules" > /dev/null
if [ $? -eq 0 ]; then
  echo "âš ï¸ Advertencia: Se encontraron usos de 'export default'. Considera usar exportaciones nombradas."
fi

# 5. DetecciÃ³n de console.log, debugger, TODO
echo "ğŸ•µï¸ Buscando console.log, debugger o TODOs..."
grep -rnw './http' -e 'console.log\|debugger\|TODO' --include \*.ts
if [ $? -eq 0 ]; then
  echo "â›” Se encontraron 'console.log', 'debugger' o 'TODO'. Eliminalos antes de commitear."
  exit 1
fi

# 6. Agente de AuditorÃ­a de Seguridad
echo "ğŸ”’ Realizando auditorÃ­a de seguridad de dependencias..."
pnpm audit
if [ $? -ne 0 ]; then
  echo "âš ï¸  Se encontraron vulnerabilidades de seguridad. Revisa el reporte de 'pnpm audit'."
  # No usamos 'exit 1' aquÃ­ para no ser demasiado restrictivos, pero se podrÃ­a aÃ±adir.
fi

# 7. Agente de VerificaciÃ³n de TamaÃ±o de Bundle (Deshabilitado hasta crear el script)
# echo "ğŸ“ Verificando el tamaÃ±o del bundle..."
# pnpm run check-bundle-size 
# if [ $? -ne 0 ]; then
#   echo "â›” El tamaÃ±o del bundle excede el lÃ­mite permitido."
#   exit 1
# fi

# 8. VerificaciÃ³n del build
echo "ğŸ“¦ Ejecutando el build del proyecto con Rollup..."
pnpm run build
if [ $? -ne 0 ]; then
  echo "â›” El build fallÃ³. Revisa los errores de compilaciÃ³n antes de commitear."
  exit 1
fi

echo "âœ… Todas las verificaciones pasaron correctamente."