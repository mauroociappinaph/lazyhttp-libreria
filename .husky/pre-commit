#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Ejecutando verificaciones pre-commit con Husky para httplazy..."

# 1. Lint y formato sobre archivos staged
npx lint-staged
if [ $? -ne 0 ]; then
  echo "‚õî Fallaron las verificaciones de linting o formato. No se puede realizar el commit."
  exit 1
fi

# 2. Test unitarios relacionados con los cambios
echo "üß™ Ejecutando tests unitarios relacionados..."
# Ejecuta tests solo para los archivos relacionados con los cambios staged
pnpm test --findRelatedTests $(git diff --name-only --cached)
if [ $? -ne 0 ]; then
  echo "‚õî Los tests fallaron. No se puede realizar el commit."
  exit 1
fi

# 3. Verificaci√≥n de dependencias circulares
echo "üìä Verificando dependencias circulares..."
npx madge --circular http/
if [ $? -ne 0 ]; then
  echo "‚õî Se detectaron dependencias circulares. Ejecuta 'npx madge --circular http/' para m√°s detalles."
  exit 1
fi

# 4. Revisi√≥n de export default
echo "üì¶ Verificando reglas de exportaci√≥n..."
grep -r "export default" http/ --include="*.ts" | grep -v "node_modules" > /dev/null
if [ $? -eq 0 ]; then
  echo "‚ö†Ô∏è Advertencia: Se encontraron usos de 'export default'. Considera usar exportaciones nombradas."
fi

# 5. Detecci√≥n de console.log, debugger, TODO
echo "üïµÔ∏è Buscando console.log, debugger o TODOs..."
grep -rnw './http' -e 'console.log\|debugger\|TODO' --include \*.ts
if [ $? -eq 0 ]; then
  echo "‚õî Se encontraron 'console.log', 'debugger' o 'TODO'. Eliminalos antes de commitear."
  exit 1
fi

echo "‚úÖ Todas las verificaciones pasaron correctamente."